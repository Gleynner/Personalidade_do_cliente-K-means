---
title: "Análise de Personalidade do Cliente"
author: "Gleynner Ghiotto"
output:
  github_document:
    df_print: paged
    number_sections: true
    toc: true
#    toc_float: true
#    toc_depth: 3
#    theme: readable
#    highlight: pygments
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align='center',comment = "")
```

```{r, include=FALSE}
# Instalar/carregar pacotes


# Lista de pacotes que serão utilizados:
r_pkgs <- c('tidyverse', 'readxl','kableExtra', 'xlsx', 'knitr','ggcorrplot','cowplot',
            'patchwork','lubridate','corrplot')

# Instala o pacote pacman se ele não estiver instalado:
if(!"pacman" %in% rownames(installed.packages())) install.packages("pacman")

# Carrega os pacotes listados:
pacman::p_load(char = r_pkgs)
```

```{r, include=FALSE}
# Funções


# Funçao 1
func_my_summary<- function(df){
  return(
    data.frame('Variavel'=df %>% names(), 
               'Tipo'=df %>% summarise_all(typeof) %>%gather() %>% select(value) %>% pull(),
               'N'=df %>% summarise_all(list( n = ~ n()))%>%gather() %>% select(value) %>% pull(),
               'Missing'=df %>% map_df(function(x) sum(is.na(x))) %>%gather() %>% 
                 select(value) %>% pull(),
               'Missing_Percent'=df %>%map_df(function(x) sum(is.na(x))/length(x)*100) %>%
                 gather() %>% select(value) %>% pull() %>% round(1),
               'N_unique'=df %>%map_df(function(x) length(unique(x))) %>%gather() %>%
                 select(value) %>% pull()
    )
  )
}

# Funçao 3
my_summary <- function(x, digits = 4){
  resumo <- c(
    #N        = length(x),
    Min      = min(x, na.rm = T),
    Q1       = unname(quantile(x, probs = 0.25, na.rm = T)),
    Mediana  = median(x, na.rm = T),
    Media    = mean(x, na.rm = T),
    Q3       = unname(quantile(x, probs = 0.75, na.rm = T)),
    Max      = max(x, na.rm = T),
    DevPad   = sd(x, na.rm = T),
    N_missing     = sum(is.na(x), na.rm = T)
  )
    return(round(resumo, digits = digits))
}

# Funçao 4
my_summary_all <- function(base, digits = 2){
  cl <- sapply(base, function(x) class(x)[1])
  nu <- cl[which(cl %in% c("numeric","integer"))]
  sa <- sapply(base[,names(nu)], function(x) my_summary(x, digits = digits))
  sa <- as.data.frame(sa)
  return(sa)
}

# função 5
simple_table <- function(data){
    kable(x = data, format="html", escape = F, align = "c") %>% 
    kable_styling(bootstrap_options ="striped") %>%
    row_spec(0,
             bold = T,
             color = "black",
             background = "darkgrey") %>%
    scroll_box(width = "100%")
}

# função 6
scroll_table <- function(data){
  kable(data) %>% kable_styling(bootstrap_options ="striped") %>%
    row_spec(0,
             bold = T,
             color = "black",
             background = "darkgrey") %>%
    scroll_box(width = "100%", height = "500px")
}

```

# Atributos

- **Pessoas**:

**ID:** Identificador único do cliente    <br>
**Year_Birth:** Ano de nascimento do cliente   <br>
**Education:** Nível de instrução do cliente    <br>
**Marital_Status:** Estado civil do cliente    <br>
**Income:** Renda familiar anual do cliente    <br>
**Kidhome:** Número de crianças na residência do cliente    <br>
**Teenhome:** Número de adolescentes na casa do cliente    <br>
**Dt_Customer:** Data do cadastro do cliente na empresa    <br>
**Recency:** Quantidade de dias desde a última compra do cliente    <br>
**Complain:** 1 se o cliente reclamou nos últimos 2 anos, 0 caso contrário    <br>


- **Produtos**:

**MntWines:** Montante gasto em vinho nos últimos 2 anos    <br>
**MntFruits:** Montante gasto com frutas nos últimos 2 anos    <br>
**MntMeatProducts:** Valor gasto com carnes nos últimos 2 anos    <br>
**MntFishProducts:** Valor gasto em pescado nos últimos 2 anos    <br>
**MntSweetProducts:** Valor gasto em doces nos últimos 2 anos    <br>
**MntGoldProds:** Valor gasto em dinheiro nos últimos 2 anos    <br>


- **Promoção**:

**NumDealsPurchases:** Número de compras feitas com desconto    <br>
**AcceptedCmp1:** 1 se o cliente aceitou a oferta na 1ª campanha, 0 caso contrário    <br>
**AcceptedCmp2:** 1 se o cliente aceitou a oferta na 2ª campanha, 0 caso contrário    <br>
**AcceptedCmp3:** 1 se o cliente aceitou a oferta na 3ª campanha, 0 caso contrário    <br>
**AcceptedCmp4:** 1 se o cliente aceitou a oferta na 4ª campanha, 0 caso contrário    <br>
**AcceptedCmp5:** 1 se o cliente aceitou a oferta na 1ª campanha, 0 caso contrário    <br>
**Response:** 1 se o cliente aceitou a oferta na última campanha, 0 caso contrário    <br>


- **Local**:

**NumWebPurchases:** Número de compras feitas pelo site da empresa    <br>
**NumCatalogPurchases:** Número de compras feitas usando um catálogo    <br>
**NumStorePurchases:** Número de compras feitas diretamente nas lojas    <br>
**NumWebVisitsMonth:** Número de visitas ao site da empresa no último mês    <br>


# Examinando o conjunto de dados (Geral):

```{r, comment="", fig.align='center'}
# carregar dados
dados <- read.csv("G:/Meu Drive/Dados_R/PORTFOLIO/Customer_personality_analysis/marketing_campaign.csv",
                  header = TRUE, sep = "\t")
head(dados, n=10)
```

```{r, comment=""}
cat("O Data Frame original possui", dim(dados)[1],"linhas e", dim(dados)[2],"colunas")
```

```{r, comment=""}
cat("Variáveis presentes no Data Frame: \n", colnames(dados), "\n Total de variáveis:", length(colnames(dados)), sep = " \n ")
```

## Detectando Valores ausentes (NA)

```{r, comment="", fig.align='center'}
func_my_summary(dados)
```

```{r, comment=""}
cat("Índices das linhas com valores ausentes para a variável Income: ",which(is.na(dados$Income)), "\nTotal de NA's:", sum(is.na(dados$Income)), sep = "\n" )
```

```{r, comment=""}
# Eliminar valores NA da variável Income
dados_1 <- dados %>% drop_na(Income)         #dados_1 é o data frame que sofrerá alteração nesta parte exploratória.

cat("Quantidade de valores ausentes (NA) após eliminação:", sum(is.na(dados_1)))
```

## Detectando valores duplicados

```{r, comment=""}
cat("Quantidade de valores duplicados é:", sum(duplicated(dados_1)))
```

## Eliminar colunas indesejadas

```{r, comment=""}
unique(dados_1$Z_CostContact)
unique(dados_1$Z_Revenue)
dados_1[,c("Z_CostContact","Z_Revenue")] <- NULL

cat('Após a exclusão das variáveis Z_CostContact e Z_Revenue, o data frame "dados_1" possui',
    dim(dados_1)[2],
    'colunas. Tais variáveis foram eliminadas por possuirem o mesmo valor para todas as observações.')
```

## Estatísticas

```{r, comment="", fig.align='center'}
my_summary_all(dados_1)
```

# Análises univariadas

## ID (Identificador único do cliente)

```{r, comment=""}
summary(dados_1$ID)

cat("Quantidade de valores distintos em ID é igual a", 
    length(unique(dados_1$ID)),"em um total de",dim(dados_1)[1],
    "linhas/valores.\n\nQuantidade de valores duplicados:",
    sum(duplicated(dados_1$ID)))
```

## Year_Birth (Ano de nascimento do cliente)

```{r, comment="", fig.align='center'}
summary(dados_1$Year_Birth)
boxplot(dados_1$Year_Birth,horizontal = T)
```

```{r, comment="", fig.align='center'}
# Calcular a idade do cliente
dados_1$Idade <- round(year(Sys.Date())-dados_1$Year_Birth, digits = 2)

summary(dados_1$Idade)
boxplot(dados_1$Idade,horizontal = T)
# Percebe-se clientes com idade muito elevada
```

```{r, comment="", fig.align='center'}
dados_1 <- dados_1[dados_1$Idade < 120,]

summary(dados_1$Idade)
```

```{r, comment=""}
# as dez idades mais frequentes
head(dados_1 %>% count(Idade) %>% arrange(desc(n)),10)
```

## Education (Nível de instrução do cliente)

```{r, comment=""}
# Corrigir categorias da variável Education
dados_1$Education[dados_1$Education %in% c("Basic","2n Cycle")] <- "Undergraduate"
dados_1$Education[dados_1$Education %in% c("Graduation","Master","PhD")] <- "Postgraduate"

cat("As categorias existentes em Education são:\n",
    unique(dados_1$Education),sep = "\n")
```

```{r, comment="", fig.align='center'}
# Quantidade de Undergraduate e Postgraduate
n_educacao <- dados_1 %>% count(Education) %>% mutate(percentage= n/dim(dados_1)[1],
                      percent_lab = paste0(round(percentage*100,2),"%")) 

ggplot(data = n_educacao) +
  geom_col(aes(x = Education, y = n), width =0.5) +
  labs(x = "Educação",y = "Quantidade") +
  theme_bw() +
  geom_text(aes(x = Education, y = n,label=percent_lab), vjust = -0.5) +
  scale_y_continuous(limits = c(0,2100), labels = scales::comma)
```

## Marital_Status (Estado civil do cliente)

```{r, comment=""}
unique(dados_1$Marital_Status)
```

```{r, comment=""}
# COrrigir classes da variável Marital_Status
dados_1$Marital_Status[dados_1$Marital_Status %in% c("Single","Divorced","Absurd","Widow","YOLO")] <- "Alone"
dados_1$Marital_Status[dados_1$Marital_Status %in% c("Married","Together")] <- "In couple"

cat("As classificações para o estado civil são: \n",unique(dados_1$Marital_Status)[1],unique(dados_1$Marital_Status)[2], sep = "\n")
```

```{r, comment="", fig.align='center'}
# Quantidade de Alone e In couple
n_marital <- dados_1 %>% count(Marital_Status) %>% 
  mutate(percentage = n/dim(dados_1)[1],
          percent_lab = paste0(round(percentage*100,2),"%"))

ggplot(data = n_marital) +
  geom_col(aes(x = Marital_Status, y = n), width =0.5) +
  labs(x = "Estado civil",y = "Quantidade") +
  theme_bw() +
  geom_text(aes(x = Marital_Status, y = n,label=percent_lab), vjust = -0.5) +
  scale_y_continuous(limits = c(0,1500))
```

## Income (Renda familiar anual do cliente)

```{r, comment="", fig.align='center'}
summary(dados_1$Income)

par(mfrow = c(1,2))
boxplot(dados_1$Income, horizontal = T,xlab = "Renda anual")
hist(dados_1$Income,breaks = 100, main = NULL,xlab = "Renda anual")

# Existe a presença de outliers!!! 
```

```{r, comment=""}
# Eliminar valor discrepante da variável Income
dados_1 <- dados_1[dados_1$Income < 600000,]
```

```{r, comment="", fig.align='center'}
summary(dados_1$Income)
par(mfrow = c(1,2))
boxplot(dados_1$Income, horizontal = T, xlab = "Renda anual")
hist(dados_1$Income,breaks = 100,xlab = "Renda anual", main = NULL)
```

## Kidhome e Teenhome (Número de crianças e adolescentes na residência do cliente)

```{r, comment="", fig.align='center'}
unique(dados_1$Kidhome)
unique(dados_1$Teenhome)
```

```{r, comment="", fig.align='center'}
percent_kidhome <- as.data.frame(prop.table(table(dados_1$Kidhome)))
g1 <- ggplot(data = percent_kidhome) +
  geom_col(aes(x = Var1, y = Freq), width =0.5) +
  labs(x="Nº de crianças",y = "Percentual", title = "kidhome") +
  scale_y_continuous(limits = c(0,1), labels = scales::percent) +
  theme_bw()

percent_Teenhome <- as.data.frame(prop.table(table(dados_1$Teenhome)))
g2 <- ggplot(data = percent_Teenhome) +
  geom_col(aes(x = Var1, y = Freq), width =0.5) +
  labs(x="Nº de adolescentes",y = "Percentual", title = "Teenhome") +
  scale_y_continuous(limits = c(0,1), labels = scales::percent) +
  theme_bw()
(g1+g2)
```

```{r, comment=""}
# Cálculo do total de Filhos
dados_1$N_Children <- dados_1$Kidhome + dados_1$Teenhome 
```

```{r, comment=""}
dados_1$Has_Children <- ifelse(dados_1$N_Children > 0,"Has child","No child")
unique(dados_1$Has_Children)


dados_1$Children <- ifelse(dados_1$N_Children == 3, "3 children",
                                ifelse(dados_1$N_Children == 2, "2 children",
                                       ifelse(dados_1$N_Children == 1, "1 children",
                                              "No children")))
unique(dados_1$N_Children); unique(dados_1$Children)
```

```{r, comment="", fig.align='center'}
percent_Children <- as.data.frame(prop.table(table(dados_1$Children)))
percent_Children$Var1 <- factor(percent_Children$Var1,
                                   levels= c("No children","1 children",
                                             "2 children","3 children"))

ggplot(data = percent_Children) +
  geom_col(aes(x = Var1, y = Freq), width =0.5) +
  labs(x="Nº de filhos",y = "Percentual") +
  scale_y_continuous(limits = c(0,1),labels = scales::percent_format(scale = 100,accuracy =5L)) +
  theme_bw()
```

## Dt_Customer (Data do cadastro do cliente na empresa)

```{r, comment=""}
dados_1$Dt_Customer <- as_date(dmy(dados_1$Dt_Customer))
class(dados_1$Dt_Customer)

#(min(dados_1$Dt_Customer) %--% max(dados_1$Dt_Customer) %/% days(x=1))/365
summary(dados_1$Dt_Customer)
```

```{r, comment="", fig.align='center'}
# quantidade de dias desde a inscrição do cliente na empresa até o dia atual
dados_1$Dt_inscricao_ate_atual <- Sys.Date() - dados_1$Dt_Customer
dados_1$Dt_inscricao_ate_atual <- as.numeric(dados_1$Dt_inscricao_ate_atual)

summary(dados_1$Dt_inscricao_ate_atual)
```

## Recency (Quantidade de dias desde a última compra do cliente)

```{r, comment="", fig.align='center'}
summary(dados_1$Recency)
```

## Variáveis MntWines, MntFruits, MntMeatProducts, MntFishProducts, MntSweetProducts e MntGoldProds

```{r, comment=""}
summary(dados_1$MntWines)
summary(dados_1$MntFruits)
summary(dados_1$MntMeatProducts)
summary(dados_1$MntFishProducts)
summary(dados_1$MntSweetProducts)
summary(dados_1$MntGoldProds)
```

```{r, comment=""}
# Calcular a quantia total gasta nos últimos 2 anos
dados_1$Gasto_total <- dados_1$MntWines + dados_1$MntFruits + dados_1$MntMeatProducts +
  dados_1$MntFishProducts + dados_1$MntSweetProducts + dados_1$MntGoldProds

# MntWines: Amount spent on wine in last 2 years
# MntFruits: Amount spent on fruits in last 2 years
# MntMeatProducts: Amount spent on meat in last 2 years
# MntFishProducts: Amount spent on fish in last 2 years
# MntSweetProducts: Amount spent on sweets in last 2 years
# MntGoldProds: Amount spent on gold in last 2 years
```

```{r, comment="", fig.align='center'}
summary(dados_1$Gasto_total)

par(mfrow = c(1,2))
boxplot(dados_1$Gasto_total,horizontal = T,xlab ="Gasto total")
hist(dados_1$Gasto_total, breaks = 100,xlab ="Gasto total", main = NULL)
```

```{r, comment="", fig.align='center'}
head(dados_1 %>% arrange(desc(Gasto_total)) %>%
  select("Marital_Status","Education","Idade","Income","Gasto_total"),10)
```

## NumDealsPurchases (Número de compras feitas com desconto)

```{r, comment="", fig.align='center'}
summary(dados_1$NumDealsPurchases)

par(mfrow = c(1,2))
boxplot(dados_1$NumDealsPurchases, horizontal = T,xlab ="Compras com desconto")
hist(dados_1$NumDealsPurchases, breaks = 100,xlab ="Compras com desconto", main = NULL)
```

```{r, comment=""}
# Quantidade de compra realizada com desconto
dados_1 %>% count(NumDealsPurchases)
```

## NumWebPurchases, NumCatalogPurchases e NumStorePurchases

```{r, comment=""}
# Número total de compras por cliente
dados_1$Numero_compras <- dados_1$NumWebPurchases + dados_1$NumCatalogPurchases + 
  dados_1$NumStorePurchases
```

```{r, comment="", fig.align='center'}
summary(dados_1$Numero_compras)

par(mfrow = c(1,2))
boxplot(dados_1$Numero_compras,xlab ="Nº de compras por cliente", horizontal = T)
hist(dados_1$Numero_compras, breaks = 100,xlab ="Nº de compras por cliente", main = NULL)
```

```{r, fig.align='center'}
local <- c("Web","Catalogo","Store")
valor <- c(sum(dados_1$NumWebPurchases),
           sum(dados_1$NumCatalogPurchases),
           sum(dados_1$NumStorePurchases))
local_vendas <- data.frame(local,valor)
local_vendas$local <- factor(local_vendas$local, levels = c("Catalogo","Web","Store"))

ggplot(data = local_vendas) +
  geom_col(aes(x = reorder(local,-valor), y = valor), width = 0.5) +
  labs(x = "Local de compra",y = "Quantidade total comprada em cada local") +
  theme_bw() + geom_text(aes(x = local, y = valor,label=valor), vjust = -0.5) +
  scale_y_continuous(limits = c(0,14000))
```

## NumWebVisitsMonth (Número de visitas ao site da empresa no último mês)

```{r, comment="", fig.align='center'}
summary(dados_1$NumWebVisitsMonth)
```

## Variáveis AcceptedCmp1, AcceptedCmp2, AcceptedCmp3, AcceptedCmp4 e AcceptedCmp5

```{r, comment=""}
unique(dados_1$AcceptedCmp1)
unique(dados_1$AcceptedCmp2)
unique(dados_1$AcceptedCmp3)
unique(dados_1$AcceptedCmp4)
unique(dados_1$AcceptedCmp5)

# AcceptedCmp1: 1 if customer accepted the offer in the 1st campaign, 0 otherwise
# AcceptedCmp2: 1 if customer accepted the offer in the 2nd campaign, 0 otherwise
# AcceptedCmp3: 1 if customer accepted the offer in the 3rd campaign, 0 otherwise
# AcceptedCmp4: 1 if customer accepted the offer in the 4th campaign, 0 otherwise
# AcceptedCmp5: 1 if customer accepted the offer in the 5th campaign, 0 otherwise
```

```{r, comment=""}
dados_1$Num_campaign_acc <- dados_1$AcceptedCmp1 + dados_1$AcceptedCmp2 + dados_1$AcceptedCmp3 + dados_1$AcceptedCmp4 + dados_1$AcceptedCmp5

unique(dados_1$Num_campaign_acc)
```

```{r, comment="", fig.align='center'}
n_campaign_acc <- dados_1 %>% count(Num_campaign_acc) %>% mutate(perc_camp = n/sum(n),
                                                                 perc_lab = paste0(round(perc_camp*100,2),"%"))
n_campaign_acc$Num_campaign_acc <-  as.factor(n_campaign_acc$Num_campaign_acc)

ggplot(data = n_campaign_acc) +
  geom_col(aes(x = Num_campaign_acc, y = n), width = 0.5) +
  labs(x = "Campanhas aceitas",y = "Quantidade") +
  theme_bw() + geom_text(aes(x = Num_campaign_acc, y = n,label=perc_lab), vjust = -0.5) +
  scale_y_continuous(limits = c(0,2000))


```

## Complain (1 se o cliente reclamou nos últimos 2 anos, 0 caso contrário)

```{r, comment=""}
unique(dados_1$Complain)

cat("Foram feitas um total de",sum(dados_1$Complain),"reclamações.")
```

```{r, comment="", fig.align='center'}
n_complain <- dados_1 %>% count(Complain)
n_complain$Complain <-  as.factor(n_complain$Complain)

ggplot(data = n_complain) +
  geom_col(aes(x = Complain, y = n), width = 0.5) +
  labs(x = "Complain",y = "Quantidade") +
  theme_bw()
```

## Response (1 se o cliente aceitou a oferta na última campanha, 0 caso contrário)

```{r, comment=""}
unique(dados_1$Response)
cat("Foram aceitas um total de",sum(dados_1$Response),"ofertas na última campanha.")
```

```{r, comment="", fig.align='center'}
n_response <- dados_1 %>% count(Response)
n_response$Response <-  as.factor(n_response$Response)

ggplot(data = n_response) +
  geom_col(aes(x = Response, y = n), width = 0.5) +
  labs(x = "Response",y = "Quantidade") +
  theme_bw()
```

## Prosseguir apenas com as colunas que seja de interesse para as análies

```{r, comment=""}
dados_2 <- dados_1 %>% select(-c("ID","Kidhome","Teenhome","MntWines","MntFruits",                                             "MntMeatProducts","MntFishProducts","MntSweetProducts","MntGoldProds",
                    "NumWebPurchases","NumCatalogPurchases","NumStorePurchases",
                    "AcceptedCmp3","AcceptedCmp4","AcceptedCmp5","AcceptedCmp1",
                    "AcceptedCmp2"))

df_eda <- dados_2 %>% select("Year_Birth","Idade","Dt_Customer","Dt_inscricao_ate_atual",
                             "Education","Marital_Status","Has_Children","N_Children",
                             "Children","Income","Gasto_total","Numero_compras",
                             "Num_campaign_acc","NumDealsPurchases","NumWebVisitsMonth",
                             "Recency","Complain","Response")
```

## Calcular o valor médio por compra

```{r, comment=""}
df_eda_1 <- df_eda[df_eda$Numero_compras > 0,]  #são eliminas apenas 6 linhas

# Número médio de compra por cliente
df_eda_1$Valor_medio_de_compra <- round(df_eda_1$Gasto_total/df_eda_1$Numero_compras, 
                                       digits = 2)
```

# Análise gráfica

## Gráfico de barras

### Nível educacional x Gasto_total

```{r, comment="", fig.align='center'}
# Gasto por nível educacional
Gst_niv_educ <- df_eda_1 %>% group_by(Education) %>% summarise(Gasto_Edu = sum(Gasto_total)) %>% 
  mutate(perc_gasto = Gasto_Edu/sum(Gasto_Edu),
         perc_lab = paste0(round(perc_gasto*100,2),"%"))

ggplot(data = Gst_niv_educ) +
  geom_col(aes(x = Education,y = Gasto_Edu), width = 0.5) +
  labs(x="Nível educacional",y = "Valor gasto") +
  theme_bw() + geom_text(aes(x = Education,y = Gasto_Edu,label=perc_lab), vjust = -0.5) +
  scale_y_continuous(limits = c(0,1300000), labels = scales::comma)
```

### Estado civil x Gasto_total

```{r, comment="", fig.align='center'}
# gasto por estado civil
Gst_est_civ <- df_eda_1 %>% group_by(Marital_Status) %>% summarise(Gasto_Marital = sum(Gasto_total)) %>% 
  mutate(perc_gasto = Gasto_Marital/sum(Gasto_Marital),
         perc_lab = paste0(round(perc_gasto*100,2),"%"))

ggplot(data = Gst_est_civ) +
  geom_col(aes(x = Marital_Status,y = Gasto_Marital), width = 0.5) +
  labs(x="Estado civil",y = "Valor gasto") +
  theme_bw()  + geom_text(aes(x = Marital_Status,y = Gasto_Marital,label=perc_lab), vjust = -0.5) +
  scale_y_continuous(limits = c(0,1000000), labels = scales::comma)
```

### Número de filhos x Gasto_total

```{r, comment="", fig.align='center'}
# gasto por quantidade de filhos
Gst_n_Children <- df_eda_1 %>% group_by(Children) %>% summarise(Gasto_Child = sum(Gasto_total)) %>% 
  mutate(perc_gasto = Gasto_Child/sum(Gasto_Child),
         perc_lab = paste0(round(perc_gasto*100,2),"%"))


Gst_n_Children$Children <- factor(Gst_n_Children$Children, levels = c("No children","1 children","2 children","3 children"))

ggplot(data = Gst_n_Children) +
  geom_col(aes(x = Children,y = Gasto_Child), width = 0.5) +
  labs(x = "Nº de filhos",y = "Valor gasto") +
  theme_bw()  + geom_text(aes(x = Children,y = Gasto_Child,label=perc_lab), vjust = -0.5) +
  scale_y_continuous(limits = c(0,800000), labels = scales::comma)
```

### Número de campanhas aceitas x Gasto_total

```{r, comment="", fig.align='center'}
# gasto pelo número de campanhas aceitas
Gst_campaign_acc <- df_eda_1 %>% 
  group_by(Num_campaign_acc) %>% summarise(Gasto_camp_acc = sum(Gasto_total)) %>% 
  mutate(perc_gasto_camp = round((Gasto_camp_acc/sum(Gasto_camp_acc))*100,2),
         perc_lab = paste0(perc_gasto_camp,"%"))

ggplot(data = Gst_campaign_acc) +
  geom_col(aes(x = Num_campaign_acc,y = Gasto_camp_acc), width = 0.5) +
  labs(x = "Campanhas aceitas",y = "Valor gasto") +
  theme_bw() + geom_text(aes(x = Num_campaign_acc,y = Gasto_camp_acc,label = perc_lab), vjust = -0.5) +
  scale_y_continuous(limits = c(0,1000000), breaks = c(0,200000,400000,600000,800000,1000000),
                     labels = scales::comma)
  
```

## Gráfico de dispersão 

```{r}
df_eda_1 %>% group_by(Education) %>% count()

df_eda_1 %>% group_by(Marital_Status) %>% count()

df_eda_1 %>% group_by(Has_Children) %>% count()

df_eda_1 %>% group_by(Children) %>% count()
```


### Renda anual x Valor médio por compra

- Disciminando por educacão

```{r, comment="", fig.align='center'}
ggplot(data = df_eda_1) +
  geom_point(aes(x = Income, y = Valor_medio_de_compra, color = Education),size=1.8) +
  labs(x="Renda anual",y="Valor médio por compra") +
  theme_bw() +
  scale_colour_manual("Nível educacional", values = c("darkorchid","deepskyblue1"))
```

- Disciminando por quantidade de filhos

```{r, comment="", fig.align='center'}
df_eda_1$Children <- factor(df_eda_1$Children, levels = c("3 children","2 children",
                                                          "1 children","No children"))


ggplot(data = df_eda_1) +
  geom_point(aes(x = Income, y = Valor_medio_de_compra, color = Children),size=1.8) +
  labs(x="Renda anual",y="Valor médio por compra") +
  theme_bw() +
  scale_colour_manual("Nº de filhos", values = c("deepskyblue1","antiquewhite3","forestgreen","darkorchid"))
```

### Renda anual x Gasto total

- Disciminando por quantidade de filhos

```{r, comment="", fig.align='center'}
ggplot(data = df_eda_1) +
  geom_point(aes(x = Income, y = Gasto_total, color = Children),size=1.8) +
  labs(x="Renda anual",y="Gasto total") +
  theme_bw() +
  scale_colour_manual("Nº de filhos", values = c("deepskyblue1","antiquewhite3","forestgreen","darkorchid"))
```

# Correlação entre variáveis 
```{r, comment="", fig.align='center', echo = F}
xy <- df_eda_1 %>% select("Idade","N_Children","Income","Numero_compras","Gasto_total",
                         "Num_campaign_acc","Dt_inscricao_ate_atual","Valor_medio_de_compra")

correlacao <- cor(xy)
corrplot(correlacao, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```

# Gerar clusters

## Renda Anual e gasto total 

```{r, comment="", fig.align='center'}
X1 = data.frame(Renda_anual = df_eda_1$Income, 
               Gasto_em_compras = df_eda_1$Gasto_total)

X1 = scale(X1)
```

```{r, comment="", fig.align='center'}
set.seed(1)
wcss = vector()
for (i in 1:10) {
  kmeans = kmeans(x = X1, centers = i)
  wcss[i] = sum(kmeans$withinss)
}

ggplot(data = data.frame(n = c(1:10),WCSS = wcss),aes(x = n, y=WCSS)) +
  geom_line(size=0.7,linetype = 1,lineend	= "round",linejoin = "round",linemitre=1) + 
  geom_point(size = 2.5) +
  labs(x="Número de clusters (k)",y="WCSS") +
  scale_x_continuous(breaks = seq(0,10,2)) +
  theme_bw()
```

```{r, comment="", fig.align='center'}
set.seed(3)
kmeans = kmeans(x = X1, centers = 2)
previsoes = kmeans$cluster

X1 <- as.data.frame(X1)

pairs(X1, col = c(1:4)[previsoes])
```

```{r, comment="", fig.align='center'}
df_resumo <- data.frame(Income=df_eda_1$Income,Gasto_total=df_eda_1$Gasto_total,Previsoes=previsoes) %>% 
  group_by(Previsoes) %>% 
  summarise(Renda_media= mean(Income), Gasto_medio = mean(Gasto_total))

previsoes = as.factor(previsoes)
df_resumo$Previsoes = as.factor(df_resumo$Previsoes)
ggplot(data = df_eda_1) +
  geom_point(aes(x=Income,y=Gasto_total,color=previsoes,fill=previsoes),size=1.8,shape=19) +
  geom_point(data=df_resumo, aes(x=Renda_media,y=Gasto_medio,color=Previsoes,fill=Previsoes), size = 5,shape=21) +
  labs(x="Renda anual",y="Gasto total em compras") +
  scale_colour_manual("Clusters",values = c("forestgreen","darkorchid2"),
                      labels = c("Cluster 1", "Cluster 2")) + 
  scale_fill_manual(name="Centroides", values=c("black","gray25")) + theme_bw()
```

## Renda Anual e Idade 

```{r, comment="", fig.align='center'}
X2 = data.frame(Renda_anual = df_eda_1$Income, 
                Idade = df_eda_1$Idade)

X2 = scale(X2)
```

```{r, comment="", fig.align='center'}
set.seed(1)
wcss2 = vector()
for (i in 1:10) {
  kmeans2 = kmeans(x = X2, centers = i)
  wcss2[i] = sum(kmeans2$withinss)
}

ggplot(data = data.frame(n = c(1:10),WCSS = wcss2),aes(x = n, y=WCSS)) +
  geom_line(size=0.7,linetype = 1,lineend	= "round",linejoin = "round",linemitre=1) + 
  geom_point(size = 2.5) +
  labs(x="Número de clusters (k)",y="WCSS") +
  scale_x_continuous(breaks = seq(0,10,2)) +
  theme_bw()
```

```{r, comment="", fig.align='center'}
set.seed(3)
kmeans2 = kmeans(x = X2, centers = 3)
previsoes2 = kmeans2$cluster

X2 <- as.data.frame(X2)

pairs(X2, col = c(1:4)[previsoes2])
```

```{r, comment="", fig.align='center'}
df_resumo2 <- data.frame(Income=df_eda_1$Income,Gasto_total=df_eda_1$Gasto_total,Previsoes=previsoes2,Idade=df_eda_1$Idade) %>% group_by(Previsoes) %>% 
  summarise(Renda_media= mean(Income), Gasto_medio = mean(Gasto_total),Idade_media = mean(Idade), max_renda =max(Income))


previsoes2 = as.factor(previsoes2)
df_resumo2$Previsoes = as.factor(df_resumo2$Previsoes)
ggplot(data = df_eda_1) +
  geom_point(aes(y=Income,x=Idade,color=previsoes2,fill=previsoes2),size=1.8,shape=19) +
  geom_point(data=df_resumo2, aes(y=Renda_media,x=Idade_media,color=Previsoes,fill=Previsoes), size = 5,shape=21) +
  labs(y="Renda anual",x=NULL, subtitle = "(a)") +
  scale_colour_manual("Clusters",values = c("forestgreen","darkorchid2","deepskyblue1","black","red"),
                      labels = c("Cluster 1", "Cluster 2","Cluster 3")) + 
  scale_fill_manual(name="Centroides", values=c("black","blue","gray25","white","red")) + theme_bw()
```

## Gasto total e Idade 

```{r, comment="", fig.align='center'}
X3 = data.frame(Gasto = df_eda_1$Gasto_total, 
                Idade = df_eda_1$Idade)

X3 = scale(X3)
```

```{r, comment="", fig.align='center'}
set.seed(1)
wcss3 = vector()
for (i in 1:10) {
  kmeans3 = kmeans(x = X3, centers = i)
  wcss3[i] = sum(kmeans3$withinss)
}
ggplot(data = data.frame(n = c(1:10),WCSS = wcss3),aes(x = n, y=wcss3)) +
  geom_line(size=0.7,linetype = 1,lineend	= "round",linejoin = "round",linemitre=1) + 
  geom_point(size = 2.5) +
  labs(x="Número de clusters (k)",y="WCSS") +
  scale_x_continuous(breaks = seq(0,10,2)) +
  theme_bw()
```

```{r, comment="", fig.align='center'}
set.seed(3)
kmeans3 = kmeans(x = X3, centers = 3)
previsoes3 = kmeans3$cluster

X3 <- as.data.frame(X3)

pairs(X3, col = c(1:4)[previsoes3])
```

```{r, comment="", fig.align='center'}
df_resumo3 <- data.frame(Income=df_eda_1$Income,Gasto_total=df_eda_1$Gasto_total,Previsoes=previsoes3,Idade=df_eda_1$Idade) %>%  group_by(Previsoes) %>% 
  summarise(Renda_media= mean(Income), Gasto_medio = mean(Gasto_total),Idade_media = mean(Idade))

previsoes3 = as.factor(previsoes3)
df_resumo3$Previsoes = as.factor(df_resumo3$Previsoes)
ggplot(data = df_eda_1) +
  geom_point(aes(y=Gasto_total,x=Idade,color=previsoes3,fill=previsoes3),size=1.8,shape=19) +
  geom_point(data=df_resumo3, aes(y=Gasto_medio,x=Idade_media,color=Previsoes,fill=Previsoes), size = 5,shape=21) +
  labs(y="Gasto em compras",x="Idade", subtitle = "(b)") +
  scale_colour_manual("Clusters",values = c("forestgreen","darkorchid2","deepskyblue1","black","red"),
                      labels = c("Cluster 1", "Cluster 2","Cluster 3")) + 
  scale_fill_manual(name="Centroides", values=c("black","blue","gray25","white","red")) + theme_bw()
```

